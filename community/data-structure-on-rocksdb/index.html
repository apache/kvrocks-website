<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-community docs-doc-id-data-structure-on-rocksdb">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Data structures design | Apache Kvrocks™</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://kvrocks.apache.org/community/data-structure-on-rocksdb"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-community-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-community-current"><meta data-rh="true" property="og:title" content="Data structures design | Apache Kvrocks™"><meta data-rh="true" name="description" content="Apache Kvrocks™ uses the RocksDB as storage, it&#x27;s developed by Facebook which is built on LevelDB with many extra features, like column family, transaction and backup, see the RocksDB wiki: Features Not In LevelDB. The basic operations in RocksDB are Put(key, value), Get(key), Delete(key), other complex structures aren&#x27;t supported."><meta data-rh="true" property="og:description" content="Apache Kvrocks™ uses the RocksDB as storage, it&#x27;s developed by Facebook which is built on LevelDB with many extra features, like column family, transaction and backup, see the RocksDB wiki: Features Not In LevelDB. The basic operations in RocksDB are Put(key, value), Get(key), Delete(key), other complex structures aren&#x27;t supported."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kvrocks.apache.org/community/data-structure-on-rocksdb"><link data-rh="true" rel="alternate" href="https://kvrocks.apache.org/community/data-structure-on-rocksdb" hreflang="en"><link data-rh="true" rel="alternate" href="https://kvrocks.apache.org/community/data-structure-on-rocksdb" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache Kvrocks™ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache Kvrocks™ Atom Feed"><link rel="stylesheet" href="/assets/css/styles.22f4841c.css">
<link rel="preload" href="/assets/js/runtime~main.f98a6897.js" as="script">
<link rel="preload" href="/assets/js/main.1586ffbf.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="apache-kvrocks" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="apache-kvrocks" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Apache Kvrocks</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/getting-started">Docs</a><a class="navbar__item navbar__link" href="/download">Download</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/community/">Community</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/users">Users</a><a href="https://github.com/apache/kvrocks" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/community/">Community</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/community/contributing">How to Contribute</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/community/category/internals">Internals</a><button aria-label="Toggle the collapsible sidebar category &#x27;Internals&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/community/data-structure-on-rocksdb">Data structures design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/community/kvrocks-search-index-encoding">Index encoding format for Kvrocks Search</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/community/category/releases">Releases</a><button aria-label="Toggle the collapsible sidebar category &#x27;Releases&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/community/create-a-release">Create a release</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/community/create-a-kvrocks-controller-release">Create a kvrocks controller release</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/community/verify-a-release-candidate">Verify a release candidate</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/community/category/committers">Committers</a><button aria-label="Toggle the collapsible sidebar category &#x27;Committers&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/community/vote-a-core-developer">Vote a new committer or PMC member</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/community/security">Security</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/community/category/internals"><span itemprop="name">Internals</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Data structures design</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Data structures design</h1><p>Apache Kvrocks™ uses the RocksDB as storage, it&#x27;s developed by Facebook which is built on LevelDB with many extra features, like column family, transaction and backup, see the RocksDB wiki: <a href="https://github.com/facebook/RocksDB/wiki/Features-Not-in-LevelDB" target="_blank" rel="noopener noreferrer">Features Not In LevelDB</a>. The basic operations in RocksDB are <code>Put(key, value)</code>, <code>Get(key)</code>, <code>Delete(key)</code>, other complex structures aren&#x27;t supported.</p><p>The main goal of this doc is to explain how we build the Redis hash/list/set/zset/bitmap/stream on RocksDB. Most of the design were derived from <a href="https://github.com/Qihoo360/blackwidow" target="_blank" rel="noopener noreferrer">Qihoo360/Blackwidow</a>, but with little modification, like the bitmap design, it&#x27;s a fascinating part.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="user-key-encoding">User Key Encoding<a href="#user-key-encoding" class="hash-link" aria-label="Direct link to User Key Encoding" title="Direct link to User Key Encoding">​</a></h2><p>Kvrocks prefixes the user key with the <code>namespace</code> and <code>cluster slot</code>. The namespace helps identify the associated namespace for each user key,
while the cluster slot determines its slot when cluster mode is enabled.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+-------------+------------------------------+-----------------+------------+-------------+-----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  ns size    |  namespace  |   cluster slot               |  user key size  |  user key  |   version   |  sub key  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| (1byte: X)  |   (Xbyte)   | (2byte when cluster enabled) |   (4byte: Y)    |   (YByte)  |   (8byte)   |  (ZByte)  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+-------------+------------------------------+-----------------+------------+-------------+-----------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="encoding-version-and-data-type">Encoding Version and Data Type<a href="#encoding-version-and-data-type" class="hash-link" aria-label="Direct link to Encoding Version and Data Type" title="Direct link to Encoding Version and Data Type">​</a></h2><p>The encoding version (currently <code>0</code> or <code>1</code>) and data type is encoded in the <code>flags</code> field. The data type is encoded from the least significant bit (LSB),
while the encoding version is encoded from the most significant bit (MSB).</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">+----------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|               flags                    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  (1byte: | version -&gt; &lt;- data type |)  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For example, the encoding version <code>0</code> and the data type String (<code>1</code>) is encoded as <code>0 0 0 0 | 0 0 0 1</code>,
while the encoding version <code>1</code> and the data type Hash (<code>2</code>) is encoded as <code>1 0 0 0 | 0 0 1 0</code>.
The values encoded for other data types in flags can be found in the table below.</p><table><thead><tr><th>data type</th><th>enum value</th></tr></thead><tbody><tr><td>String</td><td>1</td></tr><tr><td>Hash</td><td>2</td></tr><tr><td>List</td><td>3</td></tr><tr><td>Set</td><td>4</td></tr><tr><td>ZSet</td><td>5</td></tr><tr><td>Bitmap</td><td>6</td></tr><tr><td>SortedInt</td><td>7</td></tr><tr><td>Stream</td><td>8</td></tr><tr><td>BloomFilter</td><td>9</td></tr><tr><td>JSON</td><td>10</td></tr><tr><td>Hyperloglog</td><td>11</td></tr><tr><td>TDigest</td><td>12</td></tr></tbody></table><p>In the encoding version <code>0</code>, <code>expire</code> is stored in seconds and as a 4byte field (32bit integer), <code>size</code> is stored as also a 4byte field (32bit integer);
while in the encoding version <code>1</code>, <code>expire</code> is stored in milliseconds and as a 8byte field (64bit integer), <code>size</code> is stored as also a 8byte field (64bit integer).
In the following text, we will refer to the length of <code>expire</code> field as <code>Ebyte</code> and the length of <code>size</code> field as <code>Sbyte</code>, in order to describe different encoding versions consistently.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="string">String<a href="#string" class="hash-link" aria-label="Direct link to String" title="Direct link to String">​</a></h2><p>Redis string is key-value with expire time, so it&#x27;s very easy to translate the Redis string into RocksDB key-value.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        +----------+------------+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key =&gt;  |  flags   |  expire    |       payload      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | (1byte)  | (Ebyte)    |       (Nbyte)      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        +----------+------------+--------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We prepend 1-byte <code>flags</code> and 4-bytes expire before the user&#x27;s value:</p><ul><li><code>flags</code> is used to tell the Kvrocks which encoding version and type of this key-value</li><li><code>expire</code> stores the absolute time of key should be expired, zero means the key-value would never expire</li><li><code>payload</code> is the user&#x27;s raw value</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hash">Hash<a href="#hash" class="hash-link" aria-label="Direct link to Hash" title="Direct link to Hash">​</a></h2><p>Redis hashmap(dict) is like the hashmap in many programming languages, it is used to implement an associative array abstract data type, a structure that can map keys to values. The direct way to implement the hash in RocksDB is serialized the keys/values into one value and store it like the string, but the drawback is performance impact when the keys/values grew bigger. So we split the hash sub keys/values into a single key-value in RocksDB, track it with metadata.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="hash-metadata">hash metadata<a href="#hash-metadata" class="hash-link" aria-label="Direct link to hash metadata" title="Direct link to hash metadata">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        +----------+------------+-----------+-----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key =&gt;  |  flags   |  expire    |  version  |  size     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | (1byte)  | (Ebyte)    |  (8byte)  | (Sbyte)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        +----------+------------+-----------+-----------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The value of key we call it metadata here, it stored the metadata of hash key includes:</p><ul><li><code>flags</code> like the string, the field shows what type this key is</li><li><code>expire</code> is the same as the string type, record the expiration time</li><li><code>version</code> is used to accomplish fast delete when the number of sub keys/values grew bigger</li><li><code>size</code> records the number sub keys/values in this hash key</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="hash-sub-keys-values">hash sub keys-values<a href="#hash-sub-keys-values" class="hash-link" aria-label="Direct link to hash sub keys-values" title="Direct link to hash sub keys-values">​</a></h4><p>We use extra keys-values to store the hash keys-values, the format is like below:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                     +---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key|version|field =&gt; |     value     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     +---------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We prepend the hash <code>key</code> and <code>version</code> before the hash field, the value of <code>version</code> is from the metadata. For example, when the request <code>hget h1 f1</code> is received, Kvrocks fetches the metadata by hash key(here is <code>h1</code>), then concatenate the hash key, version, field as new key, then fetches the value with the new key.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Why store version in the metadata?</div><div class="admonitionContent_S0QG"><p>We store the hash keys/values into a single key-value, assume we store millions of sub keys-values in one hash key. If user delete this key, then Kvrocks must iterator millions of sub keys-values and delete them, which would cause performance problem. With version, we can quickly delete the metadata and then recycle the others keys-values in compaction background threads. The cost is those tombstone keys would take some disk storage. You can regard the version as an atomic increment number, but it&#x27;s combined with a timestamp.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="set">Set<a href="#set" class="hash-link" aria-label="Direct link to Set" title="Direct link to Set">​</a></h2><p>Redis set can be regarded as a hash, with the value of sub-key always being null, the metadata is the same with the one in hash:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        +----------+------------+-----------+-----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key =&gt;  |  flags   |  expire    |  version  |  size     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | (1byte)  | (Ebyte)    |  (8byte)  | (Sbyte)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        +----------+------------+-----------+-----------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and the sub keys-values in RocksDB would be:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                      +---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key|version|member =&gt; |     NULL      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      +---------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="list">List<a href="#list" class="hash-link" aria-label="Direct link to List" title="Direct link to List">​</a></h2><h4 class="anchor anchorWithStickyNavbar_LWe7" id="list-metadata">list metadata<a href="#list-metadata" class="hash-link" aria-label="Direct link to list metadata" title="Direct link to list metadata">​</a></h4><p>Redis list is also organized by metadata and sub keys-values, and sub key is index instead of the user key. Metadata is like below:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        +----------+------------+-----------+-----------+-----------+-----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key =&gt;  |  flags   |  expire    |  version  |  size     |  head     |  tail     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | (1byte)  | (Ebyte)    |  (8byte)  | (Sbyte)   | (8byte)   | (8byte)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        +----------+------------+-----------+-----------+-----------+-----------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>head</code> is the starting position of the list head</li><li><code>tail</code> is the stopping position of the list tail</li></ul><p>The meaning of other fields are the same as other types, just add extra head/tail to record the boundary of the list.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="list-sub-keys-values">list sub keys-values<a href="#list-sub-keys-values" class="hash-link" aria-label="Direct link to list sub keys-values" title="Direct link to list sub keys-values">​</a></h4><p>The subkey in list is composed by list key, version and index, index is calculated from metadata&#x27;s head or tail. For example, when the user requests the <code>rpush list elem</code>, Kvrocks would fetch the metadata with list key, then generate the subkey with list key, version and tail, simply increase the tail, then write the metadata and subkey&#x27;s value back to RocksDB.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                     +---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key|version|index =&gt; |     value     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     +---------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="zset">ZSet<a href="#zset" class="hash-link" aria-label="Direct link to ZSet" title="Direct link to ZSet">​</a></h2><p>Redis zset is set with sorted property, so it&#x27;s a little different from other types. It must be able to search with the member, as well as to retrieve members with score range.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="zset-metadata">zset metadata<a href="#zset-metadata" class="hash-link" aria-label="Direct link to zset metadata" title="Direct link to zset metadata">​</a></h4><p>The metadata of zset is still same with set, like below:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        +----------+------------+-----------+-----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key =&gt;  |  flags   |  expire    |  version  |  size     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | (1byte)  | (Ebyte)    |  (8byte)  | (Sbyte)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        +----------+------------+-----------+-----------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="zset-sub-keys-values">zset sub keys-values<a href="#zset-sub-keys-values" class="hash-link" aria-label="Direct link to zset sub keys-values" title="Direct link to zset sub keys-values">​</a></h4><p>The value of sub key isn&#x27;t null, we need a way to range the members with the score. So the zset has two types of sub keys-values, one for mapping the members-scores, and one for score range.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                            +---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key|version|member       =&gt; |     score     |   (1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            +---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            +---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key|version|score|member =&gt; |     NULL      |   (2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            +---------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If the user wants to get the score of the member or check the member exists or not, it would try the first one.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="bitmap">Bitmap<a href="#bitmap" class="hash-link" aria-label="Direct link to Bitmap" title="Direct link to Bitmap">​</a></h2><p>Redis bitmap is the most interesting part in Kvrocks design, unlike other types, it&#x27;s not subkey and the value would be very large if the user treats it as a sparse array. It&#x27;s apparent that the things would break down if we store the bitmap into a single value, so we should break the bitmap value into multiple fragments. Another behavior of bitmap is writing to arbitrary index, it&#x27;s very similar to the access model of the Linux virtual memory, so the idea of the bitmap design came from that.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="bitmap-metadata">bitmap metadata<a href="#bitmap-metadata" class="hash-link" aria-label="Direct link to bitmap metadata" title="Direct link to bitmap metadata">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        +----------+------------+-----------+-----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key =&gt;  |  flags   |  expire    |  version  |  size     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | (1byte)  | (Ebyte)    |  (8byte)  | (Sbyte)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        +----------+------------+-----------+-----------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="bitmap-sub-keys-values">bitmap sub keys-values<a href="#bitmap-sub-keys-values" class="hash-link" aria-label="Direct link to bitmap sub keys-values" title="Direct link to bitmap sub keys-values">​</a></h4><p>We break the bitmap values into fragments(1KiB, 8192 bits/fragment), and subkey is the index of the fragment. For example, when the request to set the bit of 1024 would locate in the first fragment with index 0, to set a bit of 80970 would locate in 10th fragment with index 9.</p><p>We use least-significant bit (LSB) numbering (also known as bit-endianness). This means that within a group of 8 bits, we read right-to-left. This is different from applying &quot;bit&quot; commands to string.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                     +---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key|version|index =&gt; |    fragment   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     +---------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When the user requests to get it of position P, Kvrocks would first fetch the metadata with bitmap&#x27;s key and calculate the index of the fragment with bit position, then fetch the bitmap fragment with composed key and find the bit in fragment offset. For example, <code>getbit bitmap 8193</code>, the fragment index is <code>1</code> (8193/8192) and subkey is <code>bitmap|1|1024</code> (when the version is 1, and fragment index is <code>1</code>, kvrocks will use <code>1 * 1024</code> as the index key), then fetch the subkey from RocksDB and check if the bit of offset <code>1</code>(8193%8192) is set or not.</p><p>A nonexistent segment means all bits are 0 in this segment. The bitmap design is very efficient when the bitmap is sparse. Besides, a segment could be less than 1KiB, and the &quot;padding&quot; bits are always regarded as 0.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sortedint">SortedInt<a href="#sortedint" class="hash-link" aria-label="Direct link to SortedInt" title="Direct link to SortedInt">​</a></h2><p>SortedInt is a set with members being type int and sorted in ascending order:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        +----------+------------+-----------+-----------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key =&gt;  |  flags   |  expire    |  version  |  size     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | (1byte)  | (Ebyte)    |  (8byte)  | (Sbyte)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        +----------+------------+-----------+-----------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And the sub keys-values in RocksDB would be:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                  +---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key|version|id =&gt; |      NULL     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  +---------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="stream">Stream<a href="#stream" class="hash-link" aria-label="Direct link to Stream" title="Direct link to Stream">​</a></h2><p>Each entry in a stream has its unique ID in the form of <code>MS-SEQ</code> where <code>MS</code> is the number of milliseconds and <code>SEQ</code> is the counter for entries added within the same millisecond. These two values are concatenated with the <code>-</code> (minus sign). The entry ID may be generated by the server or explicitly set by the client. A stream metadata tracks the ID of the last added entry.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="stream-metadata">stream metadata<a href="#stream-metadata" class="hash-link" aria-label="Direct link to stream metadata" title="Direct link to stream metadata">​</a></h4><p>Redis stream is organized by the metadata and sub keys-values. The metadata has fields mentioned before (<code>flags</code>, <code>expiration</code>, <code>version</code>, <code>size</code>) and additional fields, that are specific only for this data type. The structure of the metadata value is the following:</p><ul><li><code>flags</code> (1 byte)</li><li><code>expiration</code> (Ebytes)</li><li><code>version</code> (8 bytes)</li><li><code>size</code> (Sbytes)</li><li><code>LGE ID MS</code> (8 bytes) stores the <code>MS</code> value of the last generated entry ID</li><li><code>LGE ID SEQ</code> (8 bytes) stores the <code>SEQ</code> value of the last generated entry ID</li><li><code>RFE ID MS</code> (8 bytes) stores the <code>MS</code> value of the very first entry ID that was added to the stream</li><li><code>RFE ID SEQ</code> (8 bytes) stores the <code>SEQ</code> value of the very first entry ID that was added to the stream</li><li><code>MDE ID MS</code> (8 bytes) stores the <code>MS</code> value of the max deleted entry ID</li><li><code>MDE ID SEQ</code> (8 bytes) stores the <code>SEQ</code> value of the max deleted entry ID</li><li><code>FE ID MS</code> (8 bytes) stores the <code>MS</code> value of the current first entry ID</li><li><code>FE ID SEQ</code> (8 bytes) stores the <code>SEQ</code> value of the current first entry ID</li><li><code>LE ID MS</code> (8 bytes) stores the <code>MS</code> value of the current last entry ID</li><li><code>LE ID SEQ</code> (8 bytes) stores the <code>SEQ</code> value of the current last entry ID</li><li><code>TNE</code> (8 bytes) stores the total number of entries that were added to the stream during its lifetime</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="stream-sub-keys-values">stream sub keys-values<a href="#stream-sub-keys-values" class="hash-link" aria-label="Direct link to stream sub keys-values" title="Direct link to stream sub keys-values">​</a></h4><p>The sub-key in a stream is composed by the stream key, version and the entry ID. The entry ID is encoded as two consecutive 8-bytes integer values (<code>EID MS</code> and <code>EID SEQ</code>). The stream entry value may represent any even number of strings. This value is encoded as a sequence of strings and each string value is prepended by its length as a 4-bytes variable integer.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                              +-----------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key|version|EID MS|EID SEQ =&gt; |     encoded value     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              +-----------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="stream-consumer-group-metadata">stream consumer group metadata<a href="#stream-consumer-group-metadata" class="hash-link" aria-label="Direct link to stream consumer group metadata" title="Direct link to stream consumer group metadata">​</a></h4><p>The consumer group metadata contains the basic information of the consumer group used in the <code>XINFO GROUPS</code> command.
The key starts with the stream name, version, UINT64_MAX as a delimiter, GROUP_META which is hardcoded with 1 and consumer group name.
The composition of value is:</p><ul><li>number of consumers in the group</li><li>the length of the group&#x27;s PEL (pending entries list)</li><li>the ID of the last entry delivered to the group&#x27;s consumers</li><li>the ID of the last entry delivered to the group&#x27;s consumers</li><li>the number of entries in the stream that are still waiting to be delivered to the group&#x27;s consumers.</li></ul><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                                                +-----------------+----------------+-------------------+--------------+-------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key|version|UINT64_MAX|GROUP_META|group_name =&gt; | consumer number | pending number | last delivered id | entries read |  lag  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                |     (8byte)     |     (8byte)    |      (8byte)      |    (8byte)   |(8byte)|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                +-----------------+----------------+-------------------+--------------+-------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="stream-consumer-metadata">stream consumer metadata<a href="#stream-consumer-metadata" class="hash-link" aria-label="Direct link to stream consumer metadata" title="Direct link to stream consumer metadata">​</a></h4><p>A consumer group contains several consumers and each consumer also has its own metadata which is used in the <code>XINFO CONSUMERS</code> command.
The key starts with the stream key, version, UINT64_MAX as a delimiter, CONSUMER_META which is hardcoded with 2, consumer group name, consumer name.
The composition of value is:</p><ul><li>the number of entries in the PEL</li><li>the timestamp of the last consumer interaction</li><li>the timestamp of the last successful consumer interaction (actually read or claimed some entries).</li></ul><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                                                                 +----------------+-----------------------+----------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key|version|UINT64_MAX|CONSUMER_META|group_name|consumer_name =&gt; | pending number | last interaction time | last successful interaction time |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                 |     (8byte)    |        (8byte)        |            (8byte)               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                 +----------------+-----------------------+----------------------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="pel-entries">PEL entries<a href="#pel-entries" class="hash-link" aria-label="Direct link to PEL entries" title="Direct link to PEL entries">​</a></h4><p>A PEL entry is created after <code>XREADGROUP</code> command and each entry contains some metadata. The key is composed by the stream key, version, UINT64_MAX as a delimiter, PEL_ENTRY which is hardcoded with 3, group name and the entry ID. The value is composed by last delivery time, last delivery count and consumer name. The consumer name indicates the owner of the entry and can be quickly changed by XCLAIM command.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                                                              +--------------------+---------------------+---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key|version|UINT64_MAX|PEL_ENTRY|group_name|EID MS|EID SEQ =&gt; | last delivery time | last delivery count | consumer name |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                              |       (8byte)      |       (8byte)       |    (Nbyte)    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                              +--------------------+---------------------+---------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="bloom-filter">Bloom Filter<a href="#bloom-filter" class="hash-link" aria-label="Direct link to Bloom Filter" title="Direct link to Bloom Filter">​</a></h2><p>Redis Bloom filter is a space-efficient probabilistic data structure used to test whether an element is a member of a set. It&#x27;s implemented as <a href="https://redis.io/docs/data-types/probabilistic/bloom-filter/" target="_blank" rel="noopener noreferrer">a Redis module</a>, which means it can be used to efficiently perform set membership tests.</p><p>The underlying structure of a Bloom filter is a bit array, which is a fixed-size array of bits, typically implemented as a contiguous block of memory and storage. We choose &quot;split block bloom filter&quot;, as described in section 2.1 of <a href="https://www.eecs.harvard.edu/~michaelm/postscripts/im2005b.pdf" target="_blank" rel="noopener noreferrer">Network Applications of Bloom Filters: A Survey</a>. In a split block bloom filter, the bit array is divided into fixed-size blocks, and each block is treated as an independent Bloom filter. This approach allows for more efficient memory usage, especially when dealing with relatively large Bloom filters. The split block bloom filter is utilized in various systems such as RocksDB, Parquet, and Impala. For further details, please refer to the <a href="https://github.com/apache/parquet-format/blob/master/BloomFilter.md" target="_blank" rel="noopener noreferrer">BloomFilter.md</a> document.</p><p>We also enable users to scale the Bloom filter without needing to know the specific number of elements. As the number of elements in a Bloom filter grows, the probability of false positives also increases. To address this, one approach is to utilize a layered Bloom filter, also known as a cascading Bloom filter. In a layered Bloom filter, multiple independent Bloom filters are used in a cascading fashion. When checking for membership, the element is first checked against the first (top) filter. If it is not found, it is then checked against the second filter, and so on. This approach allows for a more controlled false positive rate, as each layer can be tuned to a different false positive probability. Additionally, when a layer becomes full, a new layer can be added, allowing the Bloom filter to dynamically adapt to changes in the number of elements. This layered structure effectively maintains the efficiency and effectiveness of the Bloom filter as the number of elements grows.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="bloom-filter-metadata">Bloom Filter metadata<a href="#bloom-filter-metadata" class="hash-link" aria-label="Direct link to Bloom Filter metadata" title="Direct link to Bloom Filter metadata">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">              +---------+---------+---------+---------+-----------------------+-----------+---------------+------------+-------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              | flags   | expire  | version |  size   | number of sub-filters | expansion | base_capacity | error_rate | bloom_bytes |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> key =&gt;       +---------+---------+---------+---------+-----------------------+-----------+---------------+------------+-------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              | (1byte) | (Ebyte) | (8byte) | (Sbyte) | (2byte)               | (2byte)   | (4byte)       | (8byte)    | (4byte)     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              +---------+---------+---------+---------+-----------------------+-----------+---------------+------------+-------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="bloom-filter-sub-keys-values">Bloom Filter sub keys-values<a href="#bloom-filter-sub-keys-values" class="hash-link" aria-label="Direct link to Bloom Filter sub keys-values" title="Direct link to Bloom Filter sub keys-values">​</a></h4><p>We break the bitmap values into fragments(each fragment is a split block bloom filter with size <code>base_capacity * (expansion ^ index)</code>), and subkey is the index of the fragment.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">             +---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key|index =&gt; |    filter     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             +---------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="json">JSON<a href="#json" class="hash-link" aria-label="Direct link to JSON" title="Direct link to JSON">​</a></h2><p>Kvrocks supports the JSON data type just like <a href="https://redis.io/docs/data-types/json/" target="_blank" rel="noopener noreferrer">RedisJSON</a>, which implements various data operations on <a href="https://ecma-international.org/publications-and-standards/standards/ecma-404/" target="_blank" rel="noopener noreferrer">ECMA-404 The JSON Data Interchange Standard</a>.</p><p>The current underlying encoding of JSON data type is relatively simple and similar to String:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        +----------+------------+-----------+--------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key =&gt;  |  flags   |  expire    |  format   |       payload      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | (1byte)  | (Ebyte)    |  (1byte)  |       (Nbyte)      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        +----------+------------+-----------+--------------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>where the <code>payload</code> is a string encoded in the corresponding <code>format</code>:</p><table><thead><tr><th>format</th><th>enum value</th></tr></thead><tbody><tr><td>JSON</td><td>0</td></tr><tr><td>CBOR</td><td>1</td></tr></tbody></table><p>Also, if we decide to add a more IO-friendly format to avoid reading all payload to the memory before searching an element via JSONPath or seperate a relatively large JSON to multiple key-values, we can take advantage of the <code>format</code> field.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hyperloglog">HyperLogLog<a href="#hyperloglog" class="hash-link" aria-label="Direct link to HyperLogLog" title="Direct link to HyperLogLog">​</a></h2><p>Redis HyperLogLog is a probabilistic data structure that estimates the cardinality of a set. The idea comes from <a href="http://algo.inria.fr/flajolet/Publications/FlFuGaMe07.pdf" target="_blank" rel="noopener noreferrer">original paper</a> and <a href="http://static.googleusercontent.com/media/research.google.com/en//pubs/archive/40671.pdf" target="_blank" rel="noopener noreferrer">paper from Google</a>.  It is particularly useful for applications that require the estimation of unique elements in massive datasets, such as network traffic analysis, data warehousing, and large-scale databases.</p><p>The principle behind HyperLogLog is based on the idea that the number of leading zeros in the binary representation of a hash value can be used to infer the size of the set. It includes:</p><ol><li>Hashing: Each element in the dataset is passed through a hash function, which produces a fixed-size binary string.</li><li>Register Array: The algorithm maintains an array of registers, each corresponding to a subset of the hash space. The size of the array is 2^p, where p is a precision parameter that determines the trade-off between accuracy and memory usage.  The HyperLogLog algorithm uses a subset of the hash value to determine the index in the register array. Specifically, it takes the first p bits of the hash value.</li></ol><p>For the remaining bits of the hash value (after the first p bits), the algorithm counts the number of leading zeros. Each entry in the array keeps track of the maximum observed for all elements that hash to the same index. If the newly encountered value is greater than the current value in the register, it updates the register with this new value.</p><p>Redis HyperLogLog can be thought of as a static array with a length of 16384. The array elements are called registers, which are used to store the maximum count of consecutive 0s. This register array is the input parameter for the HyperLogLog algorithm. The Redis HyperLogLog implementation uses up to 12 KB and provides a standard error of 0.81%.</p><p>In Kvrocks, the hyperloglog data structure is stored in following two parts:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="hyperloglog-metadata">HyperLogLog metadata<a href="#hyperloglog-metadata" class="hash-link" aria-label="Direct link to HyperLogLog metadata" title="Direct link to HyperLogLog metadata">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        +----------+------------+-----------+--------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key =&gt;  |  flags   |  expire    |  version  |  HLLType     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        | (1byte)  | (Ebyte)    |  (8byte)  | (1byte)      |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        +----------+------------+-----------+--------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>HLLType = 0 means a &quot;dense&quot; representation with Redis-like modified MurmurHash2 and 16384 registers with 6bit LSB numbers,
the values is stored like Bitmap but has smaller segment(768 bytes per segment).</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="hyperloglog-sub-keys-values">hyperloglog sub keys-values<a href="#hyperloglog-sub-keys-values" class="hash-link" aria-label="Direct link to hyperloglog sub keys-values" title="Direct link to hyperloglog sub keys-values">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                     +---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key|version|index =&gt; |    fragment   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     +---------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The register index is calculated using the first 14 bits of the user element&#x27;s hash value (64 bits), which is why the register array length is 16384.
The length of consecutive zeros is calculated using the last 50 digits of the hash value of the user key.</p><p>Inspired by the bitmap implementation, HyperLogLog divides the register array into 16 segments, each with 1024 registers.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tdigest">TDigest<a href="#tdigest" class="hash-link" aria-label="Direct link to TDigest" title="Direct link to TDigest">​</a></h2><p><a href="https://redis.io/blog/t-digest-in-redis-stack/" target="_blank" rel="noopener noreferrer">Redis TDigest</a> is a data structure that estimates the quantiles of a dataset.
It could be used for monitoring, online gaming, predictive analytics, and other applications that require real-time data analysis.</p><p><a href="https://arxiv.org/abs/1902.04023" target="_blank" rel="noopener noreferrer">The original paper</a> is based on the idea of clustering data points into centroids, which are then used to estimate the quantiles of the dataset.</p><p>The key points of TDigest are parts below:</p><ol><li>Scale function: the scale function determines the distribution of the centroids. For a certain scale, one parameter called compression will change the density of the centroids.</li><li>Merge: when the number of centroids exceeds a certain threshold, the TDigest will merge the centroids to reduce the memory usage and let it satisfy the compression parameter after merging. The merge could also be used to merge two TDigests.</li><li>Quantile estimation: when try to calculate the quantile, the TDigest will find the nearest two centroids and interpolate the quantile value.</li></ol><p>In Kvrocks, the TDigest data structure is stored in following three parts:</p><ol><li>TDigest metadata</li><li>TDigest buffer of data for batch inserting and merging into centroids</li><li>TDigest centroids</li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tdigest-metadata">TDigest metadata<a href="#tdigest-metadata" class="hash-link" aria-label="Direct link to TDigest metadata" title="Direct link to TDigest metadata">​</a></h4><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">            +----------+------------+-----------+----------------+----------------+-----------------+-----------------+---------------+----------------+----------------+--------------------+--------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key =&gt;  |  flags   |  expire    |  version  |  compression   |  capacity      |  unmerged_nodes |  merged_nodes   | total_weight  |   minimum      |   maximum      | total_observations | merge_times  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            | (1byte)  | (Ebyte)    |  (8byte)  |  uint32(4byte) |  uint32(4byte) |  uint64(8byte)  |  uint64(8byte)  | uint64(8byte) | double(8byte)  | double(8byte)  |   uint64(8byte)    | uint64(8byte)|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            +----------+------------+-----------+----------------+----------------+-----------------+-----------------+---------------+----------------+----------------+--------------------+--------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tdigest-buffer-sub-keys-values">TDigest buffer sub keys-values<a href="#tdigest-buffer-sub-keys-values" class="hash-link" aria-label="Direct link to TDigest buffer sub keys-values" title="Direct link to TDigest buffer sub keys-values">​</a></h4><p><code>buffer</code> is serialized as a list of double values.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                               +--------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key|version|BUFFER_FLAG =&gt; |    buffer    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               +--------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tdigest-centroids-sub-keys-values">TDigest centroids sub keys-values<a href="#tdigest-centroids-sub-keys-values" class="hash-link" aria-label="Direct link to TDigest centroids sub keys-values" title="Direct link to TDigest centroids sub keys-values">​</a></h4><p><code>mean</code> is the mean of each centroid and use <a href="https://github.com/apache/kvrocks/blob/80168018b6fdbc0bdd549cf78cd5798556eb070f/src/common/encoding.cc#L32" target="_blank" rel="noopener noreferrer">memcomparable serialization</a> to make iteration keep the original order of mean.</p><p>During each merge, we will flush the buffer to the centroids and merge the centroids to satisfy the compression parameter.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">                                       +----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key|version|CENTROID_FLAG|mean =&gt;  |      weight    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       | (8byte) double |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       +----------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/apache/kvrocks-website/tree/main/community/data-structure-on-rocksdb.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/community/category/internals"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Internals</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/community/kvrocks-search-index-encoding"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Index encoding format for Kvrocks Search</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#user-key-encoding" class="table-of-contents__link toc-highlight">User Key Encoding</a></li><li><a href="#encoding-version-and-data-type" class="table-of-contents__link toc-highlight">Encoding Version and Data Type</a></li><li><a href="#string" class="table-of-contents__link toc-highlight">String</a></li><li><a href="#hash" class="table-of-contents__link toc-highlight">Hash</a></li><li><a href="#set" class="table-of-contents__link toc-highlight">Set</a></li><li><a href="#list" class="table-of-contents__link toc-highlight">List</a></li><li><a href="#zset" class="table-of-contents__link toc-highlight">ZSet</a></li><li><a href="#bitmap" class="table-of-contents__link toc-highlight">Bitmap</a></li><li><a href="#sortedint" class="table-of-contents__link toc-highlight">SortedInt</a></li><li><a href="#stream" class="table-of-contents__link toc-highlight">Stream</a></li><li><a href="#bloom-filter" class="table-of-contents__link toc-highlight">Bloom Filter</a></li><li><a href="#json" class="table-of-contents__link toc-highlight">JSON</a></li><li><a href="#hyperloglog" class="table-of-contents__link toc-highlight">HyperLogLog</a></li><li><a href="#tdigest" class="table-of-contents__link toc-highlight">TDigest</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started">Getting started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/supported-commands">Supported commands</a></li><li class="footer__item"><a class="footer__link-item" href="/community/contributing">How to contribute</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://join.slack.com/t/kvrockscommunity/shared_invite/zt-p5928e3r-OUAK8SUgC8GOceGM6dAz6w" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/kvrocks/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://lists.apache.org/list.html?dev@kvrocks.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mailing list<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Repositories</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/apache/kvrocks" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kvrocks<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/kvrocks-website" target="_blank" rel="noopener noreferrer" class="footer__link-item">Website<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/kvrocks-controller" target="_blank" rel="noopener noreferrer" class="footer__link-item">Controller<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://www.apache.org/" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/asf_logo.svg" alt="Apache logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo" height="128px"><img src="/img/asf_logo.svg" alt="Apache logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" height="128px"></a></div><div class="footer__copyright"><div style="text-align: left;">
          <div style="border-top: 1px solid #ccc;min-height: 60px;line-height: 20px;text-align: center;font-family: Avenir-Medium,serif;font-size: 14px;color: #999;display: flex;align-items: center;"><span>Copyright © 2025 The Apache Software Foundation. Apache Kvrocks, Kvrocks, and its feather logo are trademarks of The Apache Software Foundation. Redis and its cube logo are registered trademarks of Redis Ltd.</span></div>
        </div></div></div></div></footer></div>
<script src="/assets/js/runtime~main.f98a6897.js"></script>
<script src="/assets/js/main.1586ffbf.js"></script>
</body>
</html>