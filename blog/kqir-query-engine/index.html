<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries | Apache Kvrocks™</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://kvrocks.apache.org/blog/kqir-query-engine"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries | Apache Kvrocks™"><meta data-rh="true" name="description" content="Intro"><meta data-rh="true" property="og:description" content="Intro"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-06-02T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/pragmatwice"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kvrocks.apache.org/blog/kqir-query-engine"><link data-rh="true" rel="alternate" href="https://kvrocks.apache.org/blog/kqir-query-engine" hreflang="en"><link data-rh="true" rel="alternate" href="https://kvrocks.apache.org/blog/kqir-query-engine" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache Kvrocks™ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache Kvrocks™ Atom Feed"><link rel="stylesheet" href="/assets/css/styles.83fea2f5.css">
<link rel="preload" href="/assets/js/runtime~main.979a4c1f.js" as="script">
<link rel="preload" href="/assets/js/main.83486c1e.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(e){}return e}()||function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="apache-kvrocks" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="apache-kvrocks" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Apache Kvrocks</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/getting-started">Docs</a><a class="navbar__item navbar__link" href="/download">Download</a><a class="navbar__item navbar__link" href="/community/">Community</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/users">Users</a><a href="https://github.com/apache/kvrocks" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/kqir-query-engine">KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/kvrocks-2023-in-review">Apache Kvrocks 2023 In Review</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/kvrocks-graduated-as-tlp">Kvrocks graduated as an Apache Top-Level-Project</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/go-redis-kvrocks-opentelemetry">Getting started with Kvrocks and go-redis</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/how-we-use-rocksdb-in-kvrocks">How we use RocksDB in Kvrocks?</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">KQIR: a query engine for Apache Kvrocks that supports both SQL and RediSearch queries</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-06-02T00:00:00.000Z" itemprop="datePublished">June 2, 2024</time> · <!-- -->10 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/pragmatwice" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/pragmatwice.png" alt="PragmaTwice"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/pragmatwice" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">PragmaTwice</span></a></div><small class="avatar__subtitle" itemprop="description">Apache Kvrocks PMC Member</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="intro">Intro<a href="#intro" class="hash-link" aria-label="Direct link to Intro" title="Direct link to Intro">​</a></h2><p>TL;DR:</p><p><img loading="lazy" alt="demo" src="/assets/images/demo-bf51c4ef55445434fbb4aaef6157ec67.png" width="3116" height="2596" class="img_ev3q"></p><p>Pretty cool, right? Let&#x27;s dive in!</p><p>(The full example is provided in <a href="/blog/kqir-query-engine/#try-it">the final section</a>.)</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="apache-kvrocks">Apache Kvrocks<a href="#apache-kvrocks" class="hash-link" aria-label="Direct link to Apache Kvrocks" title="Direct link to Apache Kvrocks">​</a></h3><p><a href="https://kvrocks.apache.org/" target="_blank" rel="noopener noreferrer">Apache Kvrocks</a> is a <a href="https://redis.io/" target="_blank" rel="noopener noreferrer">Redis</a>-compatible database built on <a href="https://rocksdb.org/" target="_blank" rel="noopener noreferrer">RocksDB</a>.</p><p>It supports <a href="https://redis.io/docs/latest/develop/reference/protocol-spec/" target="_blank" rel="noopener noreferrer">the RESP protocol</a> (version 2 and 3) and <a href="/docs/supported-commands">a wide range of Redis commands</a>, encompassing core data structures like Strings, Sets, Hashes, Sorted Sets, Stream, GEO, as well as Lua Scripts, Transactions, <a href="https://redis.io/docs/latest/develop/interact/programmability/functions-intro/" target="_blank" rel="noopener noreferrer">Functions</a> and even <a href="https://redis.io/docs/latest/develop/data-types/probabilistic/bloom-filter/" target="_blank" rel="noopener noreferrer">BloomFilter</a>, <a href="https://redis.io/docs/latest/develop/data-types/json/" target="_blank" rel="noopener noreferrer">JSON</a> from the Redis Stack.</p><p>Unlike Redis which stores data in memory, Kvrocks persists data on disk for improved storage capabilities without being constrained by machine memory limit.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="the-capability-to-query">The capability to query<a href="#the-capability-to-query" class="hash-link" aria-label="Direct link to The capability to query" title="Direct link to The capability to query">​</a></h3><p>In recent years, NoSQL databases have become more popular than traditional databases because they perform better, scale easily, and are more flexible for different industries.</p><p>However, many users are unwilling to abandon the essential features of SQL databases just for performance reasons.
These include ACID transactions, expressive query capabilities inherent in SQL, as well as optimization and abstraction possibilities offered by structured data and relational algebra.
Consequently, a new category of databases known as NewSQL has emerged gradually.</p><p>Kvrocks is a NoSQL database.
While not classified as NewSQL, Kvrocks aims to strike a balance between NoSQL and NewSQL paradigms:
It aims to maintain the high performance of NoSQL while also implementing transaction guarantees and supporting more complex queries.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="redisearch">RediSearch?<a href="#redisearch" class="hash-link" aria-label="Direct link to RediSearch?" title="Direct link to RediSearch?">​</a></h3><p><a href="https://github.com/RediSearch/RediSearch" target="_blank" rel="noopener noreferrer">RediSearch</a> is a Redis module that enhances Redis with query, secondary indexing, and full-text search functionalities.
While <a href="https://redis.io/docs/latest/operate/oss_and_stack/stack-with-enterprise/search/commands/" target="_blank" rel="noopener noreferrer">its Redis commands</a> begin with <code>FT.</code> (i.e. full text), it goes beyond just full-text search.</p><p>In fact, it is Redis moving closer to SQL databases:
RediSearch enables users to create structured schemas on existing Redis JSON or HASH data for index building.
Its schema supports <a href="https://redis.io/docs/latest/develop/interact/search-and-query/basic-constructs/field-and-type-options/" target="_blank" rel="noopener noreferrer">various field types</a> such as numeric, tag, geo, text, and vector - the latter two are utilized for full-text and vector searches.
Instead of SQL support, RediSearch provides <a href="https://redis.io/docs/latest/develop/interact/search-and-query/advanced-concepts/query_syntax/" target="_blank" rel="noopener noreferrer">a unique query syntax</a> known as the RediSearch query language.</p><p>RediSearch finds applications in various fields.
One recent application involves utilizing its vector search feature to develop retrieval-augmented generation (RAG). For instance, <a href="https://www.langchain.com/" target="_blank" rel="noopener noreferrer">LangChain</a> utilizes Redis as one of its vector database.
If Kvrocks can be compatible with RediSearch, it could benefit from these ecosystem from RediSearch.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="sql">SQL?<a href="#sql" class="hash-link" aria-label="Direct link to SQL?" title="Direct link to SQL?">​</a></h3><p>RediSearch uses a unique syntax for queries, but there are some issues to consider:</p><p>Firstly, RediSearch&#x27;s schema (a.k.a. index, created with <code>FT.CREATE</code>) can be regarded as a table in an SQL database. Its query syntax also aligns semantically with SQL queries.
Given this similarity, supporting SQL should not increase significant challenges; why not include SQL support as well?</p><p>Secondly, SQL enjoys broader usage and is familiar to more individuals. It is simpler to learn at the syntax level. While developers may need time to understand RediSearch query syntax, adapting to a new SQL database often requires less effort. Furthermore, SQL offers robust support for various query features, enhanced expressive capabilities (like JOINs, subqueries, aggregations).</p><p>Finally, RediSearch query syntax suffers from some historical designs. For example, the operator precedence of AND and OR (represented by space and <code>|</code> operator in RediSearch queries) <a href="https://redis.io/docs/latest/develop/interact/search-and-query/advanced-concepts/query_syntax/#basic-syntax" target="_blank" rel="noopener noreferrer">varies across different dialect versions</a> (dialect 1 vs. dialect 2). This tribal knowledge might lead users to prefer established query languages.</p><p>To sum up, we believe that supporting SQL as a querying language would be a good decision.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="how-we-support-both">How we support both?<a href="#how-we-support-both" class="hash-link" aria-label="Direct link to How we support both?" title="Direct link to How we support both?">​</a></h2><p><img loading="lazy" alt="KQIR" src="/assets/images/KQIR-8c913ba89d056b0cdd4f5234436a7a56.png" width="1530" height="1814" class="img_ev3q"></p><p>To introduce SQL capability to Kvrocks, we need to design a robust architecture with scalability, maintainability, and strong query planning and optimization features.</p><p>We plan to accomplish this through <a href="https://github.com/apache/kvrocks/tree/unstable/src/search" target="_blank" rel="noopener noreferrer">KQIR</a>. In the context of Kvrocks, KQIR stands for both:</p><ol><li>The complete query engine, covering frontend language parsing, query optimization and execution, etc.</li><li>An intermediate language (IR) that traverses the entire query engine.</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="kqir-a-multiple-level-ir">KQIR: a multiple-level IR<a href="#kqir-a-multiple-level-ir" class="hash-link" aria-label="Direct link to KQIR: a multiple-level IR" title="Direct link to KQIR: a multiple-level IR">​</a></h3><p>To support both SQL and RediSearch queries, an intermediate language (IR) is necessary to handle them consistently in subsequent processes without concern for the user&#x27;s input language.</p><p>We have developed parsers for a subset of MySQL syntax and RediSearch queries, converting the resulting syntax tree into KQIR.</p><p>And KQIR is a multi-level IR that can represent query structures at various levels during optimization.
The initial transformation from the syntax tree results in Syntactical IR, a high-level representation of certain syntactic expressions.
As it undergoes processing by an IR optimizer, KQIR evolves into Planning IR, a low-level representation used to express query execution plans within the query engine.</p><p>Additionally, we will conduct semantic checks on the IR before optimization to ensure that the query is semantically correct.
This includes verifying that it does not include any undefined schemas or fields and uses the appropriate field types.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ir-optimizer">IR Optimizer<a href="#ir-optimizer" class="hash-link" aria-label="Direct link to IR Optimizer" title="Direct link to IR Optimizer">​</a></h3><p>The KQIR optimizer consists of multiple passes, <a href="https://llvm.org/docs/Passes.html" target="_blank" rel="noopener noreferrer">a concept borrowed from LLVM</a>.
Each pass takes IR as input, conducts analysis and modifications, and generates a new IR.</p><p>Currently, the optimizer&#x27;s passes are categorized into three main groups:</p><ul><li>expression passes for optimizing logical expressions like <code>AND</code>, <code>OR</code>, <code>NOT</code> operators;</li><li>numeric passes for optimizing numerical comparisons with an interval analysis (i.e. analyze the mathematical properties of numerical comparisons in terms of intervals) to enhance query optimization by eliminating unnecessary comparisons or improving comparison expressions;</li><li>planning passes for converting syntactical IR to planning IR and enhancing query plans through a cost model that selects optimal indexes and removes unnecessary sortings.</li></ul><p>Pass execution order is controlled by the pass manager.
A pass may run multiple times at different stages to simplify individual passes by combining them.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="plan-executor">Plan Executor<a href="#plan-executor" class="hash-link" aria-label="Direct link to Plan Executor" title="Direct link to Plan Executor">​</a></h3><p>The KQIR plan executor is built on the Volcano model.</p><p>Once the IR optimizer finishes all optimizations, the resulting IR becomes a planning IR. This will then be passed to the plan executor to create execution logic based on certain context corresponding to the plan operator.</p><p>Subsequently, Kvrocks retrieves query results through iterative execution.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="on-disk-indexing">On-disk indexing<a href="#on-disk-indexing" class="hash-link" aria-label="Direct link to On-disk indexing" title="Direct link to On-disk indexing">​</a></h3><p>Unlike Redis, which stores index data in memory, Kvrocks requires the construction of indexes on the disk.
This means that for any field type (e.g. tag, numeric), we need an encoding to reduce such index to RocksDB&#x27;s key-values.</p><p>Furthermore, we incrementally create indexes before and after JSON or HASH commands getting executed to guarantee that query results are in real-time.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="current-status">Current status<a href="#current-status" class="hash-link" aria-label="Direct link to Current status" title="Direct link to Current status">​</a></h2><p>The KQIR functionality is currently available on the <code>unstable</code> branch, supporting commands like <code>FT.CREATE</code>, <code>FT.SEARCH</code>, and <code>FT.SEARCHSQL</code> (an extension for running SQL queries) to encourage user to test.</p><p>However, as KQIR is still in early development, compatibility cannot be guaranteed and many features remain incomplete.
Thus the upcoming release (version 2.9.0) will not include any KQIR component.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="supported-field-types">Supported field types<a href="#supported-field-types" class="hash-link" aria-label="Direct link to Supported field types" title="Direct link to Supported field types">​</a></h3><p>Currently, we only support two field types: tag and numeric.</p><p>Tag fields label each data record with multiple tags for filtering in queries.
And numeric fields hold numerical data within double-precision floating-point ranges. They allow sorting and filtering by specific numerical ranges.</p><p>In the future, we plan to expand support to include vector search and full-text search capabilities alongside other field types.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="transaction-guarantees">Transaction guarantees<a href="#transaction-guarantees" class="hash-link" aria-label="Direct link to Transaction guarantees" title="Direct link to Transaction guarantees">​</a></h3><p>Currently, the transaction guarantee of KQIR is weak, which may lead to unexpected issues during use.</p><p><a href="https://github.com/apache/kvrocks/issues/2331" target="_blank" rel="noopener noreferrer">Another project in the Kvrocks community</a> aims to enhance Kvrocks&#x27; transaction support by establishing a structured framework.
We will leverage these efforts to uphold the ACID properties of KQIR and release an official version incorporating KQIR after that.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="limitation-on-ir-optimizer">Limitation on IR optimizer<a href="#limitation-on-ir-optimizer" class="hash-link" aria-label="Direct link to Limitation on IR optimizer" title="Direct link to Limitation on IR optimizer">​</a></h3><p>Currently, KQIR does not use the cost model when optimizing record sorting.
Instead, it relies on specialized logic. This could be an area for improvement soon.</p><p>Furthermore, KQIR does not currently utilize optimizations based on runtime statistics.
Our future focus will be on integrating runtime statistics into the cost model for more precise index selection.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="relationship-with-other-features">Relationship with other features<a href="#relationship-with-other-features" class="hash-link" aria-label="Direct link to Relationship with other features" title="Direct link to Relationship with other features">​</a></h3><p>KQIR integrates well with the <a href="https://kvrocks.apache.org/docs/namespace" target="_blank" rel="noopener noreferrer">namespace</a> feature.
Any index created is restricted to the current namespace and cannot be accessed in other namespaces, aligning with how other data is accessed within the namespace.</p><p>Currently, KQIR cannot be enabled in the <a href="https://kvrocks.apache.org/docs/cluster" target="_blank" rel="noopener noreferrer">cluster mode</a>.
Cluster mode support may not be implemented in the short term, but we encourage anyone to submit discussions, design proposals, or suggestions.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="compliance">Compliance<a href="#compliance" class="hash-link" aria-label="Direct link to Compliance" title="Direct link to Compliance">​</a></h3><p>While KQIR is designed to be compatible with RediSearch at the interface level, it does not include any code from RediSearch.
As previously mentioned, KQIR features a completely new framework, and its query architecture (including parsing, optimization, execution) is independent of RediSearch.</p><p>This distinction is important due to the proprietary license under which RediSearch is released.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="high-experimental">High experimental!<a href="#high-experimental" class="hash-link" aria-label="Direct link to High experimental!" title="Direct link to High experimental!">​</a></h3><p>The current implementation of KQIR is in its early experimental stage.
We advise users to consider carefully when using KQIR functionalities in a production environment, as we do not guarantee compatibility, and there may be unexpected errors.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="future-outlook">Future outlook<a href="#future-outlook" class="hash-link" aria-label="Direct link to Future outlook" title="Direct link to Future outlook">​</a></h2><p>KQIR is currently in development, and all mentioned aspects will continue to evolve.
If you&#x27;re interested, please stay updated on the progress.</p><p>Developers keen on KQIR are encouraged to get involved in the development process and join the Apache Kvrocks community.</p><p>Note that our community consists entirely of volunteers.
As an ASF community, we strive to offer an open, inclusive, and vendor-neutral environment.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="vector-search">Vector search<a href="#vector-search" class="hash-link" aria-label="Direct link to Vector search" title="Direct link to Vector search">​</a></h3><p>The design and implementation of vector search support are currently underway, which is very exciting.</p><p>In the Kvrocks community, some members have raised discussions and <a href="https://github.com/apache/kvrocks/discussions/2316" target="_blank" rel="noopener noreferrer">proposed an encoding design</a> for implementing vector search on KQIR.</p><p>As per the plan, we will initially implement an on-disk HNSW index and introduce the vector field type.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="full-text-search">Full-text search<a href="#full-text-search" class="hash-link" aria-label="Direct link to Full-text search" title="Direct link to Full-text search">​</a></h3><p>There is currently no design proposal for full-text search.</p><p>However, community members are exploring the potential of incorporating full-text indexing in KQIR via <a href="https://clucene.sourceforge.net/" target="_blank" rel="noopener noreferrer">CLucene</a> or <a href="https://github.com/pisa-engine/pisa" target="_blank" rel="noopener noreferrer">PISA</a>.</p><p>We encourage anyone interested to share their ideas or suggestions and get involved in the development and implementation.</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="more-sql-features">More SQL features<a href="#more-sql-features" class="hash-link" aria-label="Direct link to More SQL features" title="Direct link to More SQL features">​</a></h3><p>In the future, we aim to progressively broaden our support for SQL features, potentially encompassing subqueries (including common table expressions), JOIN operations, aggregation functions, and other functionalities.</p><p>Our primary focus will remain on transaction processing rather than analytical tasks.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="try-it">Try it!<a href="#try-it" class="hash-link" aria-label="Direct link to Try it!" title="Direct link to Try it!">​</a></h2><p>First, we can easily set up a Kvrocks instance via Docker images.
You also have the choice to <a href="/docs/getting-started#build-and-run-kvrocks-from-source">manually build executable from the source code</a> in the <code>unstable</code> branch.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run -it -p </span><span class="token number" style="color:#36acaa">6666</span><span class="token plain">:6666 apache/kvrocks:nightly --log-dir stdout</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, we can connect to kvrocks locally using <code>redis-cli</code>,
and create an index named <code>testidx</code> consisting a tag field <code>a</code> and numeric field <code>b</code> with the following command:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token constant" style="color:#36acaa">FT</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">CREATE</span><span class="token plain"> testidx </span><span class="token constant" style="color:#36acaa">ON</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">PREFIX</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;test:&#x27;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SCHEMA</span><span class="token plain"> a </span><span class="token constant" style="color:#36acaa">TAG</span><span class="token plain"> b </span><span class="token constant" style="color:#36acaa">NUMERIC</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Next, we can add some new data using Redis JSON commands:
(Note that it is also possible to add data before running <code>FT.CREATE</code>.)</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">SET</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">test</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">k1 $ </span><span class="token string" style="color:#e3116c">&#x27;{&quot;a&quot;: &quot;x,y&quot;, &quot;b&quot;: 11}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">SET</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">test</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">k2 $ </span><span class="token string" style="color:#e3116c">&#x27;{&quot;a&quot;: &quot;y,z&quot;, &quot;b&quot;: 22}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">SET</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">test</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">k3 $ </span><span class="token string" style="color:#e3116c">&#x27;{&quot;a&quot;: &quot;x,z&quot;, &quot;b&quot;: 33}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Finally, we can execute some SQL queries to get the desired results:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token constant" style="color:#36acaa">FT</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">SEARCHSQL</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;select * from testidx where a hastag &quot;z&quot; and b &lt; 30&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Or an equivalent RediSearch query:</p><div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token constant" style="color:#36acaa">FT</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">SEARCH</span><span class="token plain"> testidx </span><span class="token string" style="color:#e3116c">&#x27;@a:{z} @b:[-inf (30]&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you experience any issues with KQIR, please feel free to <a href="https://github.com/apache/kvrocks/issues" target="_blank" rel="noopener noreferrer">report them</a>.</p><p>Enjoy it!</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col margin-top--sm"><a href="https://github.com/apache/kvrocks-website/tree/main/blog/2024-06-02-kqir-query-engine/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/kvrocks-2023-in-review"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Apache Kvrocks 2023 In Review</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#intro" class="table-of-contents__link toc-highlight">Intro</a><ul><li><a href="#apache-kvrocks" class="table-of-contents__link toc-highlight">Apache Kvrocks</a></li><li><a href="#the-capability-to-query" class="table-of-contents__link toc-highlight">The capability to query</a></li><li><a href="#redisearch" class="table-of-contents__link toc-highlight">RediSearch?</a></li><li><a href="#sql" class="table-of-contents__link toc-highlight">SQL?</a></li></ul></li><li><a href="#how-we-support-both" class="table-of-contents__link toc-highlight">How we support both?</a><ul><li><a href="#kqir-a-multiple-level-ir" class="table-of-contents__link toc-highlight">KQIR: a multiple-level IR</a></li><li><a href="#ir-optimizer" class="table-of-contents__link toc-highlight">IR Optimizer</a></li><li><a href="#plan-executor" class="table-of-contents__link toc-highlight">Plan Executor</a></li><li><a href="#on-disk-indexing" class="table-of-contents__link toc-highlight">On-disk indexing</a></li></ul></li><li><a href="#current-status" class="table-of-contents__link toc-highlight">Current status</a><ul><li><a href="#supported-field-types" class="table-of-contents__link toc-highlight">Supported field types</a></li><li><a href="#transaction-guarantees" class="table-of-contents__link toc-highlight">Transaction guarantees</a></li><li><a href="#limitation-on-ir-optimizer" class="table-of-contents__link toc-highlight">Limitation on IR optimizer</a></li><li><a href="#relationship-with-other-features" class="table-of-contents__link toc-highlight">Relationship with other features</a></li><li><a href="#compliance" class="table-of-contents__link toc-highlight">Compliance</a></li><li><a href="#high-experimental" class="table-of-contents__link toc-highlight">High experimental!</a></li></ul></li><li><a href="#future-outlook" class="table-of-contents__link toc-highlight">Future outlook</a><ul><li><a href="#vector-search" class="table-of-contents__link toc-highlight">Vector search</a></li><li><a href="#full-text-search" class="table-of-contents__link toc-highlight">Full-text search</a></li><li><a href="#more-sql-features" class="table-of-contents__link toc-highlight">More SQL features</a></li></ul></li><li><a href="#try-it" class="table-of-contents__link toc-highlight">Try it!</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started">Getting started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/supported-commands">Supported commands</a></li><li class="footer__item"><a class="footer__link-item" href="/community/contributing">How to contribute</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://join.slack.com/t/kvrockscommunity/shared_invite/zt-p5928e3r-OUAK8SUgC8GOceGM6dAz6w" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/kvrocks/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://lists.apache.org/list.html?dev@kvrocks.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mailing list<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Repositories</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/apache/kvrocks" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kvrocks<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/kvrocks-website" target="_blank" rel="noopener noreferrer" class="footer__link-item">Website<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/kvrocks-controller" target="_blank" rel="noopener noreferrer" class="footer__link-item">Controller<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://www.apache.org/" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/asf_logo.svg" alt="Apache logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo" height="128px"><img src="/img/asf_logo.svg" alt="Apache logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" height="128px"></a></div><div class="footer__copyright"><div style="text-align: left;">
          <div style="border-top: 1px solid #ccc;min-height: 60px;line-height: 20px;text-align: center;font-family: Avenir-Medium,serif;font-size: 14px;color: #999;display: flex;align-items: center;"><span>Copyright © 2025 The Apache Software Foundation. Apache Kvrocks, Kvrocks, and its feather logo are trademarks of The Apache Software Foundation. Redis and its cube logo are registered trademarks of Redis Ltd.</span></div>
        </div></div></div></div></footer></div>
<script src="/assets/js/runtime~main.979a4c1f.js"></script>
<script src="/assets/js/main.83486c1e.js"></script>
</body>
</html>